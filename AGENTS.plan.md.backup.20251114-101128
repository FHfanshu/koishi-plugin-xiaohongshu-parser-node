# Xhs_parser 开发计划（执行中）
## 临时任务（A）：合并转发功能（in_progress）
- 步骤1 检查现有转发逻辑与配置入口（completed）
- 步骤2 实现合并转发及可选开关（in_progress）
- 步骤3 确认聊天场景并记录改动（pending）
## 临时任务（B）：分享链接视频解析（pending）
- 步骤1 处理分享链接解析流程与弱点（in_progress）
- 步骤2 实现分享链接视频解析（pending）
- 步骤3 补充测试与记录改动（pending）
### 执行记录：2025-11-14 00:17
- 复核现有 `renderBasicNote` 输出逻辑，确认当前为 `h('message')` 包裹，可作为合并转发容器。
- 研究 Koishi 消息元素规范，记录 `<message forward>` 用法与资源元素属性要求。
- 分析 `normalizeInputUrl` 与分享短链解析流程，确认需扩展客户端以提取视频媒体。
### 执行记录：2025-11-14 11:23
- 完成 Task A 步骤1：检查现有转发逻辑与配置入口
  - 添加配置选项：`enableForward`（布尔）和 `maxUrlsPerMessage`（数字）
  - 增强命令：添加 `-m/--merge` 选项处理多个链接
  - 实现处理函数：`handleSingleUrl()`、`handleMultipleUrls()`、`extractXhsUrlsFromText()`
  - 添加自动转发中间件：检测多个 XHS 链接时自动合并
  - 修复导出函数：`extractCandidateUrls` 和 `sanitizeExtractedUrl`
  - 解决构建错误：使用 `h('message', {}, ...messages)` 格式
  - 执行 `npm run build` 构建成功
## 临时任务（C）：支持分享短链解析与完整图集（completed）
- 步骤1 评估当前链接处理与图集提取逻辑（completed）
- 步骤2 实现短链提取与全图解析修复（completed）
  - 2025-11-13 23:12 排查 10 图笔记重复生成 20 图，定位 note.imageList 中 infoList 预览图重复问题
- 步骤3 确认行为并记录改动（completed）
## 临时任务（D）：完善笔记解析与日志开启（in_progress）
- 步骤1 检查现有解析逻辑与配置需求（completed）
- 步骤2 实现完整内容解析与日志配置开关（completed）
- 步骤3 确认、记录改动并同步更新计划（in_progress）
## 当前任务（E）：基础小红书世界解析重构（completed）
- 步骤1 重置需求并定义全新基础功能范围（completed）
- 步骤2 实现全新的基础解析客户端与导出接口（completed）
- 步骤3 确认基础功能并记录后续优化点（completed）
### 执行记录：2025-11-13 12:55
- 总结：确认纯 JS 足够基础笔记解析需求，建议保留 Axios/Cheerio 路径并研究 fetch/parse 模块；仅在需要动态覆盖或复杂反爬时再引入 Python。
- 输出：拟定最小解析流程（fetchHtml → extractMeta → extractMedia → formatNote）及回退顺序（JSON-LD → 内嵌脚本 JSON → OG meta）。
### 执行记录：2025-11-13 12:56
- 用户要求"从头再来重新写"，决定基于纯 JS 重构实现最基础标签解析，仅保留抓取标题、正文、首图的核心流程，并逐步恢复其他能力。
### 执行记录：2025-11-13 12:59
- 重写 `src/types.ts` 只保留 `BasicNote`、`BasicClientConfig`
- 重写 `src/utils.ts` 提供基础 URL 验证、文本格式化和消息过滤。
- 全面重写 `src/client.ts` 为 `BasicXHSClient`，仅支持 Axios + Cheerio 获取标题/正文/首图。
- 重写 `src/index.ts`，仅注册 `xhs` 指令输出基础标签内容，不再依赖中间件或高级配置。
- 执行 `npm run build` 通过。
### 执行记录
  - 提取 noteId、合并层级节点信息。
- 在 `src/index.ts` 暴露 Koishi Schema 日志开启并输出解析流程日志。
- 执行 `npm run build` 确认通过。
### 执行记录：2025-11-13 20:35
- `src/utils.ts`：新增分段笔记 URL 提取与尾缀点清理，启用单链接验证逻辑。
- `src/client.ts`：JSON 解析前替换 `undefined/NaN/Infinity`，扩展图集字段提取（含 `urlDefault/urlPre/infoList`）。
- CLI 测试短链解析，确认返回 20 张图片。
## 临时任务（F）：修复控制台警告和日志问题（completed）
- 步骤1 修复 Puppeteer 服务注册警告（completed）
- 步骤2 添加可选的控制台日志输出（completed）
- 步骤3 确认内容解析功能正常工作（completed）
- 步骤4 更新构建并验证无错误（completed）
## 临时任务（G）：QQ 机器人交互无响应排查与 JS 解析方案研究（completed）
- 步骤1 QQ 事件监听与日志链路排查（completed）
- 步骤2 确认无响应根因并提出修复方案（completed）
- 步骤3 研究参考 JS 小红书解析插件实现（completed）
更新时间：2025-11-12 23:33 (UTC+08)

## 执行记录

- 2025-11-12 15:31 创建计划，进入特殊模式。
- 2025-11-12 15:38 完成任务A：
  - 修改 `src/utils.ts`：`import type { Config }`，严格化 `validateUrl`（host 等于/子域名判断），`formatContent` 只在 `includeMetadata` 为真时输出统计；
  - 修改 `src/client.ts`：添加 `cleanupTimer`、`startCacheCleanup()` 和 `dispose()`，构造时启动定时清理，并支持卸载清理；将 `Config` 改为类型导入；
  - 修改 `src/index.ts`：指令与中间件接入 `validateUrl`、`filterContent`、`minContentLength`，自动解析单链接逐条发送（forward/普通均可），并在 `ctx.dispose` 时调用 `client.dispose()`；
  - 修改 `package.json`：将 `koishi.service.required` 的 `puppeteer` 移至 `optional`。
- 2025-11-12 16:50 完成安全修复任务：
  - 修改 `src/utils.ts`：扩展 `validateUrl` 添加SSRF防护（内网IP过滤）、协议验证；`parseXHSUrl` 增加URL长度限制和危险字符过滤；
  - 修改 `src/client.ts`：添加 `sanitizeHtml` 函数处理危险脚本；axios请求添加重定向安全检查；Puppeteer添加安全配置；改进错误处理避免敏感信息泄露；
  - 修改 `src/index.ts`：改进错误消息，避免暴露系统详细信息。
- 2025-11-12 17:12 临时变更：（G）执行：
  - 修改 `src/index.ts` 中间件，移除 `config.forwardMode === 'auto'` 条件，测试到小红书链接即自动解析。
  - 保留指令 `xhs <url>` 以兼容现有使用与管理，是否移除指令待产品确认。
- 2025-11-12 17:23 临时变更：（G）完成：
  - 删除 `src/index.ts` 中 `ctx.command('xhs <url>')` 手动指令注册，仅保留自动解析与管理指令。
  - 执行 `npm run build` 构建成功，无 TypeScript 错误。
- 2025-11-12 23:18 临时任务：（H）进展：
  - 更新 `src/index.ts` 配置 Schema，合并旧字段为标准 Koishi 配置项并保持兼容逻辑。
  - 恢复 `ctx.command('xhs <url>')` 手动指令，支持 `-f` 强制刷新与发送模式切换。
  - 重写自动解析中间件与日志输出，采用统一链接提取与权限判断。
  - 运行 `npm run build` 通过。
- 2025-11-13 11:45 临时任务：（I）阶段总结：
  - 检查 Koishi 中间件与指令流程，定位 QQ 无响应可能原因（session.channelId 判空、适配器事件映射、enableDebugLog 未开启）并给出修复建议。
  - 建议添加 QQ 适配器事件日志监听与 Koishi Logger 配置优化。
  - 研究 JS 级实现参考：`xhs-downloader`、`xhslink-parser` GitHub 项目（需处理 x-s 参数与别名）。
- 2025-11-13 11:58 临时任务：（I）执行：
  - 更新 `src/index.ts` 中间件使用归一化配置 `cfg`，确保自动解析在 QQ 平台可获取最新配置并输出调试日志。
  - 尝试执行 `npm run build`，命令异常取消，需本地手动运行确认。
 
  - 在 `src/index.ts` 中启用 `enableMiddlewareTrace` 详细日志输出：
    - `prepareLink()` 函数：添加链接准备过程的每个步骤日志（URL验证、解析、内容获取、过滤等）。
    - `dispatchContent()` 函数：添加消息发送过程的详细日志（发送模式、转发消息创建、发送结果等）。
    - `parseLinksWithLimit()` 函数：添加特殊解析过程的详细日志（特殊信息、去重过滤、回调执行等）。
  - 在 `src/client.ts` 中添加相应的详细日志支持：
    - `getContent()` 方法：记录缓存命中、未命中、使用的获取方式（Axios/Puppeteer）。
    - `getContentWithAxios()` 方法：记录请求配置、每次重试、HTTP响应状态和大小
    - `getContentWithPuppeteer()` 方法：记录页面创建、等待、选择器等等待、HTML获取等细节。
    - `parseContent()` 方法：记录HTML处理前后的数据量。
  - 所有详细日志统一使用 `[trace]` 前缀标识，便于区分和过滤。
  - 执行 `npm run build` 构建成功，无 TypeScript 错误

## 当前任务（J）：小红书视频解析功能扩展（in_progress）
- 步骤1 加强视频元数据提取（completed）
- 步骤2 优化视频内容格式化与展示（completed）
- 步骤3 添加视频处理配置选项（completed）
- 步骤4 测试确认视频解析功能（in_progress）
## 临时任务（K）：Koishi 配置与指令修复（completed）
- 步骤1 现状排查（completed）
- 步骤2 规范化配置与功能修复（completed）
- 步骤3 确认并记录改动（completed）
## 临时变更：（L）：废除前置指令，自动解析（completed）
- 目标：取消指令依赖，消息中测试到小红书链接即解析。
- 动作：中间件移除 `forwardMode === 'auto'` gating，并移除手动指令注册（保留管理指令）。
- 风险与缓存：可能存在刷屏风险，建议使用 `enableForward`、关键词屏蔽、最小长度、域名校验与群组白名单等现有限制降级。
## 总体计划

- 任务A（配置明确性与安全）：completed
  - 在 `index.ts` 接入域名验证、关键词过滤、最小长度校验（指令与中间件）：completed
  - 在 `utils.ts` 严格化 `validateUrl`、`formatContent` 避免循环 `includeMetadata`，并使用 `import type` 避免潜在循环依赖：completed
  - 自动解析多链接时发送全部结果（合并为一条 forward），而非只取第一条：completed
  - 调整 `package.json` 的 koishi 服务声明：将 `puppeteer` 从 required 移至 optional：completed
  - **安全修复任务**：completed
    - SSRF防护：添加内网IP地址过滤，阻止访问内网资源：completed
    - 输入验证强化：URL长度限制、危险字符过滤、协议验证：completed
    - 依赖安全：Puppeteer安全配置优化，禁用不必要功能：completed
    - 信息泄露防护：改进错误处理，避免暴露系统信息：completed
    - HTML内容清理：移除危险脚本和属性：completed

- 任务B（解析稳定性）：pending
  - 重构 `extractScriptData()`：放宽贪婪的正则提取，优先 JSON-LD 并规范化为 `XHSMedia[]`
  - 去重媒体链接并统一 URL 与类型标注
- 任务C（健壮性与性能）：in_progress
  - 引入并发限制（单链接解析）：in_progress（中间件顺序处理，避免 Promise.all 并发）
  - 本地化数字格式与可配置化展示：pending

## 执行记录

- 2025-11-12 15:31 创建计划，进入特殊模式。
- 2025-11-12 15:38 完成任务A：
  - 修改 `src/utils.ts`：`import type { Config }`，严格化 `validateUrl`（host 等于/子域名判断），`formatContent` 只在 `includeMetadata` 为真时输出统计；
  - 修改 `src/client.ts`：添加 `cleanupTimer`、`startCacheCleanup()` 和 `dispose()`，构造时启动定时清理，并支持卸载清理；将 `Config` 改为类型导入；
  - 修改 `src/index.ts`：指令与中间件接入 `validateUrl`、`filterContent`、`minContentLength`，自动解析单链接逐条发送（forward/普通均可），并在 `ctx.dispose` 时调用 `client.dispose()`；
  - 修改 `package.json`：将 `koishi.service.required` 的 `puppeteer` 移至 `optional`。
- 2025-11-12 16:50 完成安全修复任务：
  - 修改 `src/utils.ts`：扩展 `validateUrl` 添加SSRF防护（内网IP过滤）、协议验证；`parseXHSUrl` 增加URL长度限制和危险字符过滤；
  - 修改 `src/client.ts`：添加 `sanitizeHtml` 函数处理危险脚本；axios请求添加重定向安全检查；Puppeteer添加安全配置；改进错误处理避免敏感信息泄露；
  - 修改 `src/index.ts`：改进错误消息，避免暴露系统详细信息。
- 2025-11-12 17:12 临时变更：（L）执行：
  - 修改 `src/index.ts` 中间件，移除 `config.forwardMode === 'auto'` 条件，测试到小红书链接即自动解析。
  - 保留指令 `xhs <url>` 以兼容现有使用与管理，是否移除指令待产品确认。
- 2025-11-12 17:23 临时变更：（L）完成：
  - 删除 `src/index.ts` 中 `ctx.command('xhs <url>')` 手动指令注册，仅保留自动解析与管理指令。
  - 执行 `npm run build` 构建成功，无 TypeScript 错误。
- 2025-11-12 23:18 临时任务：（H）进展：
  - 更新 `src/index.ts` 配置 Schema，合并旧字段为标准 Koishi 配置项并保持兼容逻辑。
  - 恢复 `ctx.command('xhs <url>')` 手动指令，支持 `-f` 强制刷新与发送模式切换。
  - 重写自动解析中间件与日志输出，采用统一链接提取与权限判断。
  - 运行 `npm run build` 通过。
## 任务（G）：全面代码审查（completed）
- 2025-11-12 23:38 完成全面代码审查，包括：
  - 代码结构与架构设计：模块化清晰，建议配置分组
  - 安全性：发现类型断言、JSON 解析、拒绝 DoS 等风险
  - 性能：缓存无限制、并发未控制、内存泄漏风险
  - 错误处理：部分异常未捕获、边界情况未覆盖
  - 类型安全：as any 滥用、魔法数字、重复代码
  - 发现 10 个具体代码问题及改进方案
  - 提供立即修复、短期改进、长期优化的三级建议
  - 建议添加单元测试、集成测试和安全测试

## 任务（H）：修复高风险和中风险问题（completed）
- 2025-11-12 23:40 开始修复所有高风险和中风险问题
- 2025-11-12 23:45 完成修复，包括：

### 修复的高风险问题
1. **正则 DoS 风险**
   - 将 `\S+` 改为 `[^\s]{1,400}` 限制匹配长度
   - 添加文本长度预查（最大 50000 字符）
   - 添加单个链接长度限制（400 字符）

2. **类型断言滥用**
   - 新增 `hasPuppeteer()` 类型守卫函数
   - 移除 client.ts 中的 `(this.ctx as any).puppeteer` 断言
   - 移除 index.ts 中的 `(ctx as any).xhsParser` 断言

3. **JSON 解析安全**
   - 新增 `safeJsonParse()` 函数，限制最大解析大小（1MB）
   - 替换所有 `JSON.parse()` 调用为安全版本
   - 添加解析前文本长度检查

4. **缓存耗尽风险**
   - 实现 LRU 缓存机制（最大 200 条）
   - 添加 `cacheAccessOrder` 跟踪访问顺序
   - 缓存满时自动移除最少使用的项
   - 清理定时器同步更新访问顺序

5. **错误信息泄露**
   - 包裹所有错误输出，不暴露敏感信息
   - 只在 `enableDebugLog` 时记录详细错误
   - 统一错误处理流程

### 修复的中风险问题
6. **并发控制缺失**
   - 新增 `parseLinksWithLimit()` 函数
   - 分批并发处理（每批最多 3 个）
   - 使用 `Promise.allSettled` 避免单个失败影响全局

7. **重复代码**
   - 统一 `isPrivateIP` 和 `isLocalhost` 到 utils.ts
   - 合并重复函数为 `deduplicateMedia()`
   - 统一 HTML 清理为 `sanitizeHtml()`
   - 移除 client.ts 中重复的安全检查代码

8. **边界情况处理**
   - `formatDuration` 添加 `Number.isFinite()` 检查
   - 改进 `generateMessageId()` 避免冲突
   - 视频元数据验证（宽度、高度、时长> 0）
   - 改进 HTML sanitizer（保留合法的 data:image/ URI）

9. **代码重构**
   - 提取 `isAuthorizedGroup()` 函数
   - 提取 `extractLinkSources()` 函数
   - 提取 `dispatchContent()` 添加错误处理
   - 中间件从 100 行缩减到 45 行

  - 分析原因：
    1. extractImagesFromDetail 会遍历多个候选字段（imageList, imageUrls, images 等）
    2. 如果同一组图片存储在多个字段中，会导致重复提取
    3. 例如：imageList 包含 10 张图，imageUrls 也包含同样的 10 张，结果就是 20 张
  - 修复方案：
    1. 优先级策略：按优先级尝试字段，找到有效图片列表后立即停止
    2. 对象去重：基于图片 ID（fileId/imageId/traceId）识别并跳过重复的图片对象
    3. 调试日志：添加详细的图片提取日志，便于追踪问题
  - 修改文件：src/client.ts
    - extractImagesFromDetail：采用早返回策略，优先使用 imageList 等主要字段
    - extractImageId：新增方法，从图片对象提取唯一标识符
    - selectBestImageUrl：添加 infoList 场景选择的调试日志
  - 2025-11-14 10:05 执行 npm run build 编译成功，任务 K 完成
  - 状态：completed

